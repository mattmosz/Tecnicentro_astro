---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Ã“rdenes de Trabajo - TecniCentro Ibarra Express">
  <header class="navbar"><div class="container">
    <a href="/admin/dashboard" class="brand"><span class="logo-circle">ðŸ”§</span><span class="brand-text">TecniCentro Ibarra Express</span></a>
    <div class="user-menu"><span id="userWelcome" class="user-chip">Cargandoâ€¦</span><button id="btnLogout" class="btn btn-orange" onclick="window.logout?.()">Cerrar SesiÃ³n</button></div>
  </div></header>

  <main class="page">
    <div class="container">
      <div class="header-row">
        <div><h1>Ã“rdenes de Trabajo</h1><p class="muted">Crea, asigna y controla el estado</p></div>
        <div class="actions">
          <input id="q" class="input" placeholder="Buscar por #OT / cliente / placa" />
          <select id="fEstado" class="input">
            <option value="">Todos</option>
            <option>Pendiente</option><option>En Proceso</option><option>Completado</option><option>Entregado</option>
          </select>
          <button class="btn btn-outline" id="btnBuscar">Buscar</button>
          <button class="btn btn-orange" id="btnNuevo">Nueva Orden</button>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><h3>Listado</h3></div>
        <div class="card-body">
          <div id="wrapTable" class="table-wrap"><div class="skeleton"></div></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Orden -->
  <dialog id="modalOT">
    <form id="frmOT" method="dialog" class="modal">
      <div class="modal-head"><h3 id="modalTitle">Nueva Orden</h3><button class="icon" type="button" id="closeOT">âœ–</button></div>
      <div class="modal-body grid2">
        <label>Cliente (ID)<input name="id_cliente" required class="input"/></label>
        <label>VehÃ­culo (ID)<input name="id_vehiculo" required class="input"/></label>
        <label>Fecha Ingreso<input name="fecha_ingreso" type="date" required class="input"/></label>
        <label>Estado<select name="estado" class="input"><option>Pendiente</option><option>En Proceso</option><option>Completado</option><option>Entregado</option></select></label>
        <label>Servicios<textarea name="servicios" class="input" rows="3" placeholder="IDs o descripciones"></textarea></label>
        <label>Notas<textarea name="notas" class="input" rows="3"></textarea></label>
      </div>
      <div class="modal-foot"><button class="btn btn-outline" value="cancel">Cancelar</button><button class="btn btn-orange" id="btnGuardar" value="default">Guardar</button></div>
    </form>
  </dialog>

  <style>
    /* Reusa estilos base + badge estado */
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .b-pend{background:#fff7ed;color:#c2410c}.b-proc{background:#eff6ff;color:#1e40af}.b-comp{background:#ecfdf5;color:#065f46}
  </style>

  <script>
    // guard
    function _hardLogout(){ try{localStorage.removeItem('token');localStorage.removeItem('user')}finally{location.replace('/')} }
    window.logout=_hardLogout;
    document.addEventListener('click',(e)=>{const b=e.target.closest('#btnLogout');if(!b)return;e.preventDefault();_hardLogout();});
    (async()=>{
      const t=localStorage.getItem('token');const u=localStorage.getItem('user'); if(!t||!u) return _hardLogout();
      try{const r=await fetch('/api/auth/verify',{headers:{Authorization:`Bearer ${t}`}});const j=await r.json().catch(()=>({}));if(!r.ok||!j?.success)return _hardLogout();}catch{return _hardLogout();}
      const user=JSON.parse(u); if(user.rol!=='admin') return _hardLogout();
      document.getElementById('userWelcome').textContent=`Bienvenido, ${user.nombre}`;
      loadPage();
    })();

    let q='', estado='';
    function bcls(s){ s=(s||'').toLowerCase(); if(s==='pendiente')return 'b-pend'; if(s==='en proceso')return'b-proc'; return 'b-comp'; }

    async function loadPage(){
      const t=localStorage.getItem('token');
      const url=new URL('/api/ordenes', location.origin);
      if(q) url.searchParams.set('q', q); if(estado) url.searchParams.set('estado', estado);
      const r=await fetch(url,{headers:{Authorization:`Bearer ${t}`}});
      const items=await r.json().catch(()=>[]);
      const wrap=document.getElementById('wrapTable');
      if(!items.length){ wrap.innerHTML='<div class="muted">Sin resultados</div>'; return; }
      wrap.innerHTML=`
        <table>
          <thead><tr><th>#OT</th><th>Cliente</th><th>VehÃ­culo</th><th>Estado</th><th>Ingreso</th><th></th></tr></thead>
          <tbody>
            ${items.map(o=>`
              <tr>
                <td>#${o.id}</td>
                <td>${o.cliente_nombre||''}</td>
                <td>${o.vehiculo_placa||''}</td>
                <td><span class="badge ${bcls(o.estado)}">${o.estado}</span></td>
                <td>${o.fecha_ingreso? new Date(o.fecha_ingreso).toLocaleDateString(): 'â€”'}</td>
                <td>
                  <div class="row-actions">
                    <button class="icon-btn" data-edit='${JSON.stringify(o).replaceAll("'", "&apos;")}'>âœŽ</button>
                    <button class="icon-btn" data-del="${o.id}">ðŸ—‘</button>
                  </div>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }

    document.getElementById('btnBuscar').addEventListener('click',()=>{ q=document.getElementById('q').value.trim(); estado=document.getElementById('fEstado').value; loadPage(); });

    // modal
    const modal=document.getElementById('modalOT');
    document.getElementById('btnNuevo').addEventListener('click',()=>openModal());
    document.getElementById('closeOT').addEventListener('click',()=>modal.close());
    function openModal(data=null){
      const f=document.getElementById('frmOT'); f.reset(); f.dataset.id=data?.id||'';
      document.getElementById('modalTitle').textContent=data?'Editar Orden':'Nueva Orden';
      if(data){ for(const k of ['id_cliente','id_vehiculo','fecha_ingreso','estado','servicios','notas']) if(f[k]) f[k].value=data[k]??''; }
      modal.showModal();
    }
    document.addEventListener('click',(e)=>{
      const be=e.target.closest('button[data-edit]'); if(be){ openModal(JSON.parse(be.dataset.edit)); return; }
      const bd=e.target.closest('button[data-del]'); if(bd){ delOT(bd.dataset.del); return; }
    });
    document.getElementById('frmOT').addEventListener('submit', async (e)=>{
      e.preventDefault(); const f=e.target; const id=f.dataset.id; const t=localStorage.getItem('token');
      const payload=Object.fromEntries(new FormData(f).entries());
      const r=await fetch(id? `/api/ordenes/${id}`:'/api/ordenes',{method:id?'PUT':'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${t}`},body:JSON.stringify(payload)});
      if(r.ok){ modal.close(); loadPage(); } else alert('No se pudo guardar');
    });
    async function delOT(id){
      if(!confirm('Â¿Eliminar orden?')) return;
      const t=localStorage.getItem('token');
      const r=await fetch(`/api/ordenes/${id}`,{method:'DELETE',headers:{Authorization:`Bearer ${t}`}});
      if(r.ok) loadPage(); else alert('No se pudo eliminar');
    }
  </script>
</Layout>
