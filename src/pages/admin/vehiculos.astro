---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Veh√≠culos - TecniCentro Ibarra Express">
  <header class="navbar"><div class="container">
    <a href="/admin/dashboard" class="brand"><span class="logo-circle">üîß</span><span class="brand-text">TecniCentro Ibarra Express</span></a>
    <div class="user-menu"><span id="userWelcome" class="user-chip">Cargando‚Ä¶</span><button id="btnLogout" class="btn btn-orange" onclick="window.logout?.()">Cerrar Sesi√≥n</button></div>
  </div></header>

  <main class="page">
    <div class="container">
      <div class="header-row">
        <div><h1>Gesti√≥n de Veh√≠culos</h1><p class="muted">Registro y seguimiento de unidades</p></div>
        <div class="actions">
          <input id="q" class="input" placeholder="Buscar por placa / marca / cliente" />
          <select id="fMarca" class="input"><option value="">Todas las marcas</option></select>
          <button class="btn btn-outline" id="btnBuscar">Buscar</button>
          <button class="btn btn-orange" id="btnNuevo">Nuevo Veh√≠culo</button>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><h3>Listado</h3></div>
        <div class="card-body">
          <div id="wrapTable" class="table-wrap"><div class="skeleton"></div></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Veh√≠culo -->
  <dialog id="modalVehiculo">
    <form id="frmVehiculo" method="dialog" class="modal">
      <div class="modal-head"><h3 id="modalTitle">Nuevo Veh√≠culo</h3><button class="icon" type="button" id="closeVehiculo">‚úñ</button></div>
      <div class="modal-body grid2">
        <label>Cliente (ID)<input name="id_cliente" required class="input" /></label>
        <label>Placa<input name="placa" required class="input" /></label>
        <label>Marca<input name="marca" class="input" /></label>
        <label>Modelo<input name="modelo" class="input" /></label>
        <label>A√±o<input name="anio" type="number" class="input" /></label>
        <label>Kilometraje<input name="km" type="number" class="input" /></label>
        <label>Color<input name="color" class="input" /></label>
        <label>VIN<input name="vin" class="input" /></label>
      </div>
      <div class="modal-foot"><button class="btn btn-outline" value="cancel">Cancelar</button><button class="btn btn-orange" id="btnGuardar" value="default">Guardar</button></div>
    </form>
  </dialog>

<style>
  /* ========= Light theme tokens ========= */
  :root{
    --bg:#f6f8fb;           /* fondo claro */
    --card:#ffffff;         /* tarjetas */
    --surface:#f9fbff;      /* superficies sutiles */
    --text:#0f172a;         /* texto principal */
    --muted:#64748b;        /* texto secundario */
    --line:#e6ebf2;         /* bordes suaves */

    --brand-1:#fb923c;      /* naranja */
    --brand-2:#f59e0b;      /* √°mbar */
    --accent:#2563eb;       /* azul acci√≥n */

    --ring:0 1px 2px rgba(2,6,23,.06), 0 10px 20px rgba(2,6,23,.06);
    --radius:16px;
    --container:1200px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
  }
  .container{max-width:var(--container);margin-inline:auto;padding:0 20px}

  /* ========= Navbar (clara, sticky) ========= */
  .navbar{
    position:sticky;top:0;z-index:40;
    background:rgba(255,255,255,.88);
    backdrop-filter:saturate(160%) blur(10px);
    border-bottom:1px solid var(--line);
  }
  .navbar .container{display:flex;align-items:center;justify-content:space-between;height:70px}
  .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--text);font-weight:800}
  .logo-circle{
    display:grid;place-items:center;width:40px;height:40px;border-radius:50%;
    background:conic-gradient(from 160deg,var(--brand-1),var(--brand-2));
    box-shadow:var(--ring)
  }
  .brand-text{letter-spacing:.2px}
  .user-menu{display:flex;align-items:center;gap:12px}
  .user-chip{
    padding:8px 12px;border-radius:999px;
    background:#f4f7fb;border:1px solid var(--line);color:#334155;font-weight:700;
  }

  /* ========= Page ========= */
  .page{padding:28px 0 48px}
  .header-row{display:flex;align-items:end;justify-content:space-between;gap:12px;margin:12px 0 20px}
  h1{margin:0 0 6px;font-size:28px}
  .muted{color:var(--muted)}
  .actions{display:flex;gap:10px;flex-wrap:wrap}

  /* ========= Inputs & Buttons (claros) ========= */
  .input{
    width:auto;min-width:240px;appearance:none;outline:none;
    padding:11px 12px;border-radius:12px;background:#fff;color:var(--text);
    border:1px solid var(--line); box-shadow:0 1px 0 rgba(2,6,23,.02);
    transition:border-color .12s ease, box-shadow .12s ease, transform .12s ease;
  }
  .input::placeholder{color:#9aa9bd}
  .input:focus{
    border-color:#bfdbfe; box-shadow:0 0 0 3px rgba(59,130,246,.25)
  }
  select.input{
    padding-right:34px;background-image:
      linear-gradient(45deg, transparent 50%, #64748b 50%),
      linear-gradient(135deg, #64748b 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position: calc(100% - 18px) 55%, calc(100% - 12px) 55%, 100% 0;
    background-size:6px 6px, 6px 6px, 2.5em 2.5em; background-repeat:no-repeat;
  }

  .btn{
    appearance:none;border:1px solid var(--line);border-radius:12px;
    padding:10px 14px;font-weight:800;cursor:pointer;background:#fff;color:#0b1324;
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:var(--ring);border-color:#d7deea}
  .btn:active{transform:translateY(0)}
  .btn-outline{background:#fff}
  .btn-orange{
    color:#fff;border:1px solid #f59e0b;background:linear-gradient(180deg,var(--brand-1),#f97316);
    box-shadow:0 6px 18px rgba(251,146,60,.18)
  }
  .btn-orange:hover{box-shadow:0 8px 28px rgba(251,146,60,.28)}

  /* ========= Card ========= */
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    box-shadow:var(--ring);overflow:hidden;
  }
  .card-head{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px;border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,#ffffff,#fcfdff)
  }
  .card-head h3{margin:0;font-size:16px;font-weight:800}
  .card-body{padding:14px 16px 18px}

  /* ========= Tabla clara ========= */
  .table-wrap{overflow:auto;scrollbar-gutter:stable both-edges}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;z-index:1;background:#f8fafc;color:#64748b;
    text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.05em;
    padding:12px 10px;border-bottom:1px solid var(--line)
  }
  tbody td{padding:14px 10px;border-top:1px solid var(--line);color:#0f172a}
  tr:hover td{background:#f9fbff}
  .row-actions{display:flex;gap:8px}
  .icon-btn{
    background:#fff;border:1px solid var(--line);color:#0f172a;border-radius:10px;padding:6px 9px;cursor:pointer;
  }
  .icon-btn:hover{border-color:#cdd6e5;box-shadow:0 4px 14px rgba(2,6,23,.08)}

  /* ========= Empty / Skeleton ========= */
  .skeleton{
    height:64px;border-radius:12px;
    background:linear-gradient(90deg,#f2f5fb 25%,#eaeef6 37%,#f2f5fb 63%);
    background-size:400% 100%;animation:shimmer 1.2s infinite
  }
  @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
  #wrapTable>.muted{
    padding:18px;border:1px dashed var(--line);border-radius:12px;background:#fff
  }

  /* ========= Modal claro ========= */
  dialog::backdrop{background:rgba(15,23,42,.25)}
  dialog{
    border:0;padding:0;width:min(860px,92vw);border-radius:18px;overflow:hidden;
    background:#fff;border:1px solid var(--line);box-shadow:0 40px 80px rgba(2,6,23,.18)
  }
  .modal{background:transparent}
  .modal-head{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px;border-bottom:1px solid var(--line);background:#f9fbff
  }
  .modal-head h3{margin:0}
  .modal-body{padding:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .modal-foot{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;border-top:1px solid var(--line)}
  .modal label{display:flex;flex-direction:column;gap:8px;font-weight:700;color:#0b1324}
  .icon{
    appearance:none;background:#fff;border:1px solid var(--line);color:#0f172a;border-radius:10px;padding:6px 10px;cursor:pointer;
  }
  .icon:hover{border-color:#cdd6e5}

  /* ========= Badges (por si luego usas) ========= */
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
  .badge-warning{background:#fff7ed;color:#c2410c;border:1px solid #fde7c6}
  .badge-primary{background:#eff6ff;color:#1e40af;border:1px solid #dbeafe}
  .badge-success{background:#ecfdf5;color:#065f46;border:1px solid #d1fae5}

  /* ========= Responsive ========= */
  @media (max-width:1024px){
    .header-row{align-items:stretch;flex-direction:column}
    .actions{justify-content:flex-start}
  }
  @media (max-width:640px){
    .brand-text{display:none}
    .input{min-width:unset;width:100%}
    .grid2{grid-template-columns:1fr}
    .actions{flex-direction:column}
  }
</style>


  <script>
    // Guard
    function _hardLogout(){ try{localStorage.removeItem('token');localStorage.removeItem('user')}finally{location.replace('/')} }
    window.logout=_hardLogout;
    document.addEventListener('click',(e)=>{const b=e.target.closest('#btnLogout');if(!b)return;e.preventDefault();_hardLogout();});
    (async()=>{
      const t=localStorage.getItem('token');const u=localStorage.getItem('user'); if(!t||!u) return _hardLogout();
      try{const r=await fetch('/api/auth/verify',{headers:{Authorization:`Bearer ${t}`}});const j=await r.json().catch(()=>({}));if(!r.ok||!j?.success)return _hardLogout();}catch{return _hardLogout();}
      const user=JSON.parse(u); if(user.rol!=='admin') return _hardLogout();
      document.getElementById('userWelcome').textContent=`Bienvenido, ${user.nombre}`;
      await loadFiltros(); loadPage();
    })();

    let q='', marca='', list=[];
    async function loadFiltros(){
      const t=localStorage.getItem('token');
      const r=await fetch('/api/vehiculos/marcas',{headers:{Authorization:`Bearer ${t}`}});
      const marcas= await r.json().catch(()=>[]);
      const sel=document.getElementById('fMarca');
      sel.innerHTML = '<option value="">Todas las marcas</option>' + marcas.map(m=>`<option>${m}</option>`).join('');
    }

    async function loadPage(){
      const t=localStorage.getItem('token');
      const url=new URL('/api/vehiculos', location.origin);
      if(q) url.searchParams.set('q', q); if(marca) url.searchParams.set('marca', marca);
      const r=await fetch(url,{headers:{Authorization:`Bearer ${t}`}});
      list=await r.json().catch(()=>[]);
      renderTable(list);
    }

    function renderTable(items){
      const wrap=document.getElementById('wrapTable');
      if(!items.length){ wrap.innerHTML = '<div class="muted">Sin resultados</div>'; return; }
      wrap.innerHTML = `
        <table>
          <thead><tr><th>Placa</th><th>Marca/Modelo</th><th>A√±o</th><th>Cliente</th><th>KM</th><th></th></tr></thead>
          <tbody>
            ${items.map(v=>`
              <tr>
                <td>${v.placa||''}</td>
                <td>${(v.marca||'')+' '+(v.modelo||'')}</td>
                <td>${v.anio||''}</td>
                <td>${v.cliente_nombre||''}</td>
                <td>${v.km??''}</td>
                <td>
                  <div class="row-actions">
                    <button class="icon-btn" data-edit='${JSON.stringify(v).replaceAll("'", "&apos;")}'>‚úé</button>
                    <button class="icon-btn" data-del="${v.id}">üóë</button>
                  </div>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }

    document.getElementById('btnBuscar').addEventListener('click',()=>{ q=document.getElementById('q').value.trim(); marca=document.getElementById('fMarca').value; loadPage(); });

    // modal
    const modal=document.getElementById('modalVehiculo');
    document.getElementById('btnNuevo').addEventListener('click',()=>openModal());
    document.getElementById('closeVehiculo').addEventListener('click',()=>modal.close());
    function openModal(data=null){
      const f=document.getElementById('frmVehiculo'); f.reset(); f.dataset.id=data?.id||'';
      document.getElementById('modalTitle').textContent=data?'Editar Veh√≠culo':'Nuevo Veh√≠culo';
      if(data){ for(const k of ['id_cliente','placa','marca','modelo','anio','km','color','vin']) f[k].value = data[k]??''; }
      modal.showModal();
    }
    document.addEventListener('click',(e)=>{
      const be=e.target.closest('button[data-edit]'); if(be){ openModal(JSON.parse(be.dataset.edit)); return; }
      const bd=e.target.closest('button[data-del]'); if(bd){ delVehiculo(bd.dataset.del); return; }
    });
    document.getElementById('frmVehiculo').addEventListener('submit', async (e)=>{
      e.preventDefault(); const f=e.target; const id=f.dataset.id; const t=localStorage.getItem('token');
      const payload=Object.fromEntries(new FormData(f).entries());
      const r=await fetch(id? `/api/vehiculos/${id}`:'/api/vehiculos',{method:id?'PUT':'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${t}`},body:JSON.stringify(payload)});
      if(r.ok){ modal.close(); loadPage(); } else alert('No se pudo guardar');
    });
    async function delVehiculo(id){
      if(!confirm('¬øEliminar veh√≠culo?')) return;
      const t=localStorage.getItem('token');
      const r=await fetch(`/api/vehiculos/${id}`,{method:'DELETE',headers:{Authorization:`Bearer ${t}`}});
      if(r.ok) loadPage(); else alert('No se pudo eliminar');
    }
  </script>
</Layout>
