---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Clientes - TecniCentro Ibarra Express">
  <header class="navbar" role="banner">
    <div class="container">
      <a href="/admin/dashboard" class="brand"><span class="logo-circle">üîß</span><span class="brand-text">TecniCentro Ibarra Express</span></a>
      <div class="user-menu">
        <span id="userWelcome" class="user-chip">Cargando‚Ä¶</span>
        <button type="button" id="btnLogout" class="btn btn-orange" onclick="window.logout?.()">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <div class="header-row">
        <div>
          <h1>Gesti√≥n de Clientes</h1>
          <p class="muted">Administra tus clientes y contactos</p>
        </div>
        <div class="actions">
          <input id="q" class="input" placeholder="Buscar por CI / nombre / email" />
          <button class="btn btn-outline" id="btnBuscar">Buscar</button>
          <button class="btn btn-orange" id="btnNuevo">Nuevo Cliente</button>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><h3>Listado</h3></div>
        <div class="card-body">
          <div id="wrapTable" class="table-wrap"><div class="skeleton"></div></div>
          <div class="pager">
            <button id="prev" class="btn btn-outline" disabled>Anterior</button>
            <span id="pageInfo" class="muted">P√°gina 1</span>
            <button id="next" class="btn btn-outline" disabled>Siguiente</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Cliente -->
  <dialog id="modalCliente">
    <form id="frmCliente" method="dialog" class="modal">
      <div class="modal-head">
        <h3 id="modalTitle">Nuevo Cliente</h3>
        <button class="icon" type="button" id="closeCliente">‚úñ</button>
      </div>
      <div class="modal-body grid2">
        <label>CI/RUC<input name="identificacion" required class="input" /></label>
        <label>Nombre<input name="nombre" required class="input" /></label>
        <label>Tel√©fono<input name="telefono" class="input" /></label>
        <label>Email<input name="email" type="email" class="input" /></label>
        <label>Direcci√≥n<input name="direccion" class="input" /></label>
      </div>
      <div class="modal-foot">
        <button class="btn btn-outline" value="cancel">Cancelar</button>
        <button class="btn btn-orange" id="btnGuardarCliente" value="default">Guardar</button>
      </div>
    </form>
  </dialog>

  <style>
    :root{--bg:#f6f8fb;--card:#fff;--text:#0f172a;--muted:#64748b;--orange-500:#fb923c;--ring:0 1px 2px rgba(0,0,0,.04),0 10px 20px rgba(2,6,23,.08);--radius:16px;--container:1200px}
    .muted{color:var(--muted)} .navbar{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #eef2f7;z-index:20}
    .navbar .container{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);font-weight:700}
    .logo-circle{display:grid;place-items:center;width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--orange-500),#ffb07a);box-shadow:var(--ring)}
    .user-menu{display:flex;align-items:center;gap:12px}.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}.btn-orange{background:var(--orange-500);color:#fff}
    .container{max-width:var(--container);margin-inline:auto;padding:0 20px}.page{padding:24px 0 48px}
    .header-row{display:flex;gap:12px;align-items:end;justify-content:space-between;margin:16px 0 18px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}.input{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;min-width:240px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--ring);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
    .card-body{padding:12px 16px 16px}.table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0} thead th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left;padding:10px}
    tbody td{padding:12px 10px;border-top:1px solid #eef2f7} tr:hover td{background:#fafafa}
    .row-actions{display:flex;gap:6px}.icon-btn{border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;background:#fff}
    .skeleton{height:64px;border-radius:12px;background:linear-gradient(90deg,#f2f4f8 25%,#e6eaf1 37%,#f2f4f8 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .pager{display:flex;align-items:center;gap:10px;justify-content:flex-end;padding:10px 0}
    dialog::backdrop{background:rgba(0,0,0,.25)} dialog{border:0;border-radius:14px;padding:0;box-shadow:var(--ring);max-width:720px;width:100%}
    .modal{background:#fff;border-radius:14px;overflow:hidden}.modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eef2f7}
    .modal-body{padding:16px}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modal-foot{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #eef2f7}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}.input{min-width:unset;width:100%}}
  </style>

  <script>
    // -------- logout & guard ----------
    function _hardLogout(){ try{localStorage.removeItem('token');localStorage.removeItem('user')}finally{location.replace('/')} }
    window.logout=_hardLogout;
    document.addEventListener('click',(e)=>{const b=e.target.closest('#btnLogout');if(!b)return;e.preventDefault();_hardLogout();});
    (async()=>{
      const token=localStorage.getItem('token');const uStr=localStorage.getItem('user'); if(!token||!uStr) return _hardLogout();
      try{const r=await fetch('/api/auth/verify',{headers:{Authorization:`Bearer ${token}`}});const j=await r.json().catch(()=>({}));if(!r.ok||!j?.success)return _hardLogout();}catch{return _hardLogout();}
      const user=JSON.parse(uStr); if(user.rol!=='admin') return _hardLogout();
      document.getElementById('userWelcome').textContent=`Bienvenido, ${user.nombre}`;
      loadPage();
    })();

    // -------- page logic ----------
    let page=1, limit=10, total=0, q='';
    const fmt=new Intl.NumberFormat('es-EC');

    async function loadPage(){
      const token=localStorage.getItem('token');
      const url=new URL('/api/clientes', location.origin);
      url.searchParams.set('page', page); url.searchParams.set('limit', limit);
      if(q) url.searchParams.set('q', q);
      const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`}}); 
      const data=await r.json().catch(()=>({items:[],total:0}));
      total=data.total||0;
      renderTable(data.items||[]);
      updatePager();
    }

    function renderTable(items){
      const wrap=document.getElementById('wrapTable');
      if(!items.length){ wrap.innerHTML = '<div class="muted">Sin resultados</div>'; return; }
      wrap.innerHTML = `
        <table>
          <thead><tr>
            <th>CI/RUC</th><th>Nombre</th><th>Tel√©fono</th><th>Email</th><th>Direcci√≥n</th><th></th>
          </tr></thead>
          <tbody>
            ${items.map(c=>`
              <tr>
                <td>${c.identificacion||''}</td>
                <td>${c.nombre||''}</td>
                <td>${c.telefono||''}</td>
                <td>${c.email||''}</td>
                <td>${c.direccion||''}</td>
                <td>
                  <div class="row-actions">
                    <button class="icon-btn" data-edit='${JSON.stringify(c).replaceAll("'", "&apos;")}'>‚úé</button>
                    <button class="icon-btn" data-del="${c.id}">üóë</button>
                  </div>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }

    function updatePager(){
      const pages=Math.max(1, Math.ceil(total/limit));
      document.getElementById('pageInfo').textContent = `P√°gina ${page} de ${fmt.format(pages)} (${fmt.format(total)} registros)`;
      document.getElementById('prev').disabled = page<=1;
      document.getElementById('next').disabled = page>=pages;
    }

    // search & pager
    document.getElementById('btnBuscar').addEventListener('click', ()=>{ q=document.getElementById('q').value.trim(); page=1; loadPage(); });
    document.getElementById('prev').addEventListener('click', ()=>{ if(page>1){page--;loadPage();} });
    document.getElementById('next').addEventListener('click', ()=>{ page++;loadPage(); });

    // modal create/edit
    const modal=document.getElementById('modalCliente');
    document.getElementById('btnNuevo').addEventListener('click', ()=>{ openModal(); });
    document.getElementById('closeCliente').addEventListener('click', ()=> modal.close());

    function openModal(data=null){
      const frm=document.getElementById('frmCliente'); frm.reset();
      frm.dataset.id = data?.id || '';
      document.getElementById('modalTitle').textContent = data?'Editar Cliente':'Nuevo Cliente';
      if(data){
        frm.identificacion.value=data.identificacion||''; frm.nombre.value=data.nombre||'';
        frm.telefono.value=data.telefono||''; frm.email.value=data.email||''; frm.direccion.value=data.direccion||'';
      }
      modal.showModal();
    }

    document.addEventListener('click',(e)=>{
      const btnEdit=e.target.closest('button[data-edit]'); if(btnEdit){ openModal(JSON.parse(btnEdit.dataset.edit)); return; }
      const btnDel=e.target.closest('button[data-del]'); if(btnDel){ delCliente(btnDel.dataset.del); return; }
    });

    document.getElementById('frmCliente').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const frm=e.target;
      const payload = {
        identificacion: frm.identificacion.value.trim(),
        nombre: frm.nombre.value.trim(),
        telefono: frm.telefono.value.trim(),
        email: frm.email.value.trim(),
        direccion: frm.direccion.value.trim()
      };
      const id = frm.dataset.id;
      const token=localStorage.getItem('token');
      const r = await fetch(id? `/api/clientes/${id}` : '/api/clientes', {
        method: id? 'PUT':'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify(payload)
      });
      if(r.ok){ modal.close(); loadPage(); } else { alert('No se pudo guardar'); }
    });

    async function delCliente(id){
      if(!confirm('¬øEliminar cliente?')) return;
      const token=localStorage.getItem('token');
      const r=await fetch(`/api/clientes/${id}`,{method:'DELETE',headers:{Authorization:`Bearer ${token}`}});
      if(r.ok) loadPage(); else alert('No se pudo eliminar');
    }
  </script>
</Layout>
