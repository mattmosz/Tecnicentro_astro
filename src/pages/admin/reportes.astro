---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Reportes y An√°lisis - TecniCentro Ibarra Express">
  <header class="navbar" role="banner">
    <div class="container">
      <a href="/admin/dashboard" class="brand">
        <span class="logo-circle">üîß</span>
        <span class="brand-text">TecniCentro Ibarra Express</span>
      </a>
      <div class="user-menu">
        <span id="userWelcome" class="user-chip">Cargando‚Ä¶</span>
        <button type="button" id="btnLogout" class="btn btn-orange" onclick="window.logout?.()">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <div class="header-row">
        <div>
          <h1>Reportes y An√°lisis</h1>
          <p class="muted">Estad√≠sticas operativas y de ventas</p>
        </div>
        <div class="actions">
          <input id="fDesde" type="date" class="input" />
          <input id="fHasta" type="date" class="input" />
          <button class="btn btn-outline" id="btnAplicar">Aplicar</button>
          <button class="btn btn-orange" id="btnExport">Exportar CSV</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="stats-grid">
        <article class="kpi-card kpi-orange">
          <div class="kpi-icon">üí∞</div>
          <div>
            <h3 id="kTotal" class="kpi-value">$0</h3>
            <p class="kpi-label">Facturaci√≥n</p>
          </div>
        </article>

        <article class="kpi-card kpi-green">
          <div class="kpi-icon">üìã</div>
          <div>
            <h3 id="kOT" class="kpi-value">0</h3>
            <p class="kpi-label">√ìrdenes</p>
          </div>
        </article>

        <article class="kpi-card kpi-amber">
          <div class="kpi-icon">üõ†Ô∏è</div>
          <div>
            <h3 id="kTopSrv" class="kpi-value">‚Äî</h3>
            <p class="kpi-label">Servicio Top</p>
          </div>
        </article>

        <article class="kpi-card kpi-blue">
          <div class="kpi-icon">üë•</div>
          <div>
            <h3 id="kClientes" class="kpi-value">0</h3>
            <p class="kpi-label">Clientes nuevos</p>
          </div>
        </article>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="card-head"><h3>Ventas por d√≠a</h3></div>
          <div class="card-body">
            <div id="ventasDia" class="bars">
              <div class="muted">Sin datos</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-head"><h3>Top servicios</h3></div>
          <div class="card-body">
            <div id="topServicios" class="table-wrap">
              <div class="muted">Sin datos</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== Script ===== -->
  <script>
    //@ts-nocheck
    /* ===== logout & guard ===== */
    function _hardLogout(){
      try{
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      }finally{
        location.replace('/');
      }
    }
    window.logout = _hardLogout;

    document.addEventListener('click',(e)=>{
      const b = e.target.closest('#btnLogout');
      if(!b) return;
      e.preventDefault();
      _hardLogout();
    });

    (async()=>{
      const token = localStorage.getItem('token');
      const uStr  = localStorage.getItem('user');
      if(!token || !uStr) return _hardLogout();

      try{
        const r = await fetch('/api/auth/verify', { headers:{ Authorization:`Bearer ${token}` }});
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j?.success) return _hardLogout();
      }catch{ return _hardLogout(); }

      const user = JSON.parse(uStr);
      if(user.rol !== 'admin') return _hardLogout();
      document.getElementById('userWelcome').textContent = `Bienvenido, ${user.nombre}`;

      // Fechas por defecto (1¬∫ del mes ‚Üí hoy)
      const dDesde = document.getElementById('fDesde');
      const dHasta = document.getElementById('fHasta');
      const today  = new Date();
      const yyyy   = today.getFullYear();
      const mm     = String(today.getMonth()+1).padStart(2,'0');
      const dd     = String(today.getDate()).padStart(2,'0');
      if(!dDesde.value) dDesde.value = `${yyyy}-${mm}-01`;
      if(!dHasta.value) dHasta.value = `${yyyy}-${mm}-${dd}`;

      apply();
    })();

    /* ===== UI events ===== */
    document.getElementById('btnAplicar')?.addEventListener('click', apply);
    document.getElementById('btnExport')?.addEventListener('click', exportCSV);

    /* ===== Utils ===== */
    const money = new Intl.NumberFormat('es-EC', { style:'currency', currency:'USD' });

    /* ===== API calls ===== */
async function apply(){
  const token = localStorage.getItem('token');
  const desde = document.getElementById('fDesde').value;
  const hasta = document.getElementById('fHasta').value;

  const url = new URL('/api/reportes', location.origin);
  if (desde) url.searchParams.set('desde', desde);
  if (hasta) url.searchParams.set('hasta', hasta);
  url.searchParams.set('_ts', Date.now()); // ‚Üê cache buster

  let data = { resumen:{}, ventas_dia:[], top_servicios:[] };
  try{
    const r = await fetch(url, {
      headers: { Authorization: `Bearer ${token}` },
      cache: 'no-store' // ‚Üê no cache
    });
    if (r.status === 401) return _hardLogout();
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    data = await r.json();
  }catch(err){
    console.error('Reporte: error consultando API', err);
  }

  const { resumen = {}, ventas_dia = [], top_servicios = [] } = data;
  document.getElementById('kTotal').textContent    = money.format(resumen.total || 0);
  document.getElementById('kOT').textContent       = resumen.ordenes || 0;
  document.getElementById('kClientes').textContent = resumen.clientes_nuevos || 0;
  document.getElementById('kTopSrv').textContent   = top_servicios?.[0]?.nombre || '‚Äî';

  renderVentasDia(ventas_dia);
  renderTopServicios(top_servicios);
}

async function exportCSV(){
  const token = localStorage.getItem('token');
  const desde = document.getElementById('fDesde').value;
  const hasta = document.getElementById('fHasta').value;

  const url = new URL('/api/reportes/export', location.origin);
  if (desde) url.searchParams.set('desde', desde);
  if (hasta) url.searchParams.set('hasta', hasta);
  url.searchParams.set('_ts', Date.now()); // ‚Üê cache buster

  try{
    const r = await fetch(url, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Cache-Control': 'no-store' // ‚Üê por si acaso
      },
      cache: 'no-store'
    });
    if (r.status === 401) return _hardLogout();
    if (!r.ok) throw new Error(`HTTP ${r.status}`);

    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'reportes.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(err){
    console.error('Export CSV: error', err);
    alert('No se pudo exportar');
  }
}

    /* ===== Render ===== */
    function renderVentasDia(rows){
      const cont = document.getElementById('ventasDia');
      if(!rows.length){
        cont.innerHTML = '<div class="muted">Sin datos</div>';
        return;
      }
      const max = Math.max(...rows.map(r => +r.total || 0), 1);
      cont.innerHTML = rows.map(r => {
        const w = Math.round(((+r.total || 0) / max) * 100);
        const f = isNaN(Date.parse(r.fecha)) ? r.fecha : new Date(r.fecha).toLocaleDateString('es-EC');
        return `
          <div class="bar">
            <div class="label">${f}</div>
            <div class="track"><div class="fill" style="width:${w}%"></div></div>
            <div class="label">${money.format(+r.total || 0)}</div>
          </div>`;
      }).join('');
    }

    function renderTopServicios(items){
      const wrap = document.getElementById('topServicios');
      if(!items.length){
        wrap.innerHTML = '<div class="muted">Sin datos</div>';
        return;
      }
      wrap.innerHTML = `
        <table>
          <thead><tr><th>Servicio</th><th>Veces</th><th>Ingresos</th></tr></thead>
          <tbody>
            ${items.map(s => `
              <tr>
                <td>${s.nombre}</td>
                <td>${s.cantidad}</td>
                <td>${money.format(+s.total || 0)}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }
  </script>

  <!-- ===== Estilos ===== -->
  <style>
    :root{
      --container: 1200px;
      --bg: #f8fafc;
      --card: #fff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e6eaf1;
      --border-2: #edf1f6;
      --blue-700: #1e3a8a;
      --blue-500: #3b82f6;
      --orange: #ff4500;
      --green: #22c55e;
      --amber: #f59e0b;
      --blue: #3b82f6;
      --red: #ef4444;
    }

    .page{ padding:24px 0 40px; background:var(--bg); }
    .container{ max-width:var(--container); margin:0 auto; padding:0 20px; }
    .muted{ color:var(--muted); }

    .navbar{
      position: sticky; top:0; z-index:50;
      background: linear-gradient(135deg,var(--blue-700) 0%,var(--blue-500) 100%);
      color:#fff; box-shadow:0 6px 18px rgba(2,6,23,.12);
    }
    .navbar .container{ display:flex; align-items:center; gap:16px; padding:10px 20px; }
    .brand{ display:inline-flex; align-items:center; gap:10px; color:#fff; text-decoration:none; font-weight:700; }
    .logo-circle{ width:36px; height:36px; display:grid; place-items:center; border-radius:50%; background:rgba(255,255,255,.15); box-shadow: inset 0 0 0 1px rgba(255,255,255,.25); }
    .brand-text{ color:#fff; }
    .user-menu{ margin-left:auto; display:inline-flex; gap:12px; align-items:center; }
    .user-chip{ padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25); color:#fff; font-weight:700; font-size:.875rem; }

    #btnLogout{ background:var(--red); color:#fff; border:0; border-radius:999px; padding:8px 14px; font-weight:700; box-shadow:0 6px 14px rgba(239,68,68,.22); cursor:pointer; transition:transform .12s,box-shadow .12s; }
    #btnLogout:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(239,68,68,.28); }

    .header-row{ display:flex; justify-content:space-between; align-items:flex-end; gap:16px; margin:8px 0 14px; flex-wrap:wrap; }
    .header-row h1{ margin:0 0 6px; font-size:2rem; font-weight:800; color:#0f172a; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; font-size:.9rem; }
    .btn-orange{ background:var(--orange); color:#fff; }
    .btn-outline{ background:#fff; border:1px solid var(--border); color:var(--text); }
    .input{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; min-width:200px; font-size:.9rem; background:#fff; color:var(--text); }
    .input:focus{ outline:none; border-color:var(--blue-500); box-shadow:0 0 0 3px rgba(59,130,246,.15); }

    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px; margin:14px 0 24px; }
    .kpi-card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:18px; display:flex; align-items:center; gap:14px; box-shadow:0 8px 22px rgba(2,6,23,.06); }
    .kpi-card.kpi-orange{ border-left:4px solid var(--orange); }
    .kpi-card.kpi-green{  border-left:4px solid var(--green); }
    .kpi-card.kpi-amber{  border-left:4px solid var(--amber); }
    .kpi-card.kpi-blue{   border-left:4px solid var(--blue); }
    .kpi-icon{ font-size:28px; opacity:.85; }
    .kpi-value{ margin:0; font-size:1.5rem; font-weight:800; color:#0f172a; }
    .kpi-label{ margin:2px 0 0; color:var(--muted); font-weight:600; font-size:.85rem; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 8px 22px rgba(2,6,23,.06); overflow:hidden; }
    .card-head{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; background:#fafbfc; border-bottom:1px solid var(--border-2); }
    .card-head h3{ margin:0; font-size:1.125rem; font-weight:700; color:#0f172a; }
    .card-body{ padding:16px 18px 18px; }

    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:10px; }
    .table-wrap table{ width:100%; border-collapse:collapse; background:#fff; }
    .table-wrap thead th{ background:#f8fafc; color:#0f172a; font-weight:700; font-size:.82rem; letter-spacing:.02em; text-transform:uppercase; text-align:left; padding:14px 12px; border-bottom:2px solid var(--border); }
    .table-wrap tbody td{ padding:14px 12px; border-bottom:1px solid var(--border-2); font-size:.95rem; }
    .table-wrap tbody tr:hover{ background:#f6f9ff; }

    .bars{ display:grid; grid-auto-rows:30px; gap:10px; padding:12px; }
    .bar{ display:flex; gap:10px; align-items:center; }
    .bar .label{ min-width:96px; font-size:12px; color:#64748b; white-space:nowrap; }
    .bar .track{ flex:1; height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; }
    .bar .fill{ height:10px; background:var(--orange); border-radius:999px; }
  </style>
</Layout>
