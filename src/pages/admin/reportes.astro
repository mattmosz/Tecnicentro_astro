---
import Layout from "../../layouts/Layout.astro";
---
<Layout title="Reportes y An√°lisis - TecniCentro Ibarra Express">
  <!-- Navbar -->
  <header class="navbar">
    <div class="container">
      <a href="/admin/dashboard" class="brand">
        <span class="logo-circle">üîß</span>
        <span class="brand-text">TecniCentro Ibarra Express</span>
      </a>
      <div class="user-menu">
        <span id="userWelcome" class="user-chip">Cargando‚Ä¶</span>
        <button id="btnLogout" class="btn btn-orange" onclick="window.logout?.()">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </header>

  <!-- P√°gina -->
  <main class="page">
    <div class="container">
      <div class="header-row">
        <div>
          <h1>Reportes y An√°lisis</h1>
          <p class="muted">Estad√≠sticas operativas y de ventas</p>
        </div>
        <div class="actions">
          <input id="fDesde" type="date" class="input" />
          <input id="fHasta" type="date" class="input" />
          <button class="btn btn-outline" id="btnAplicar">Aplicar</button>
          <button class="btn btn-orange" id="btnExport">Exportar CSV</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="stats-grid">
        <article class="kpi-card kpi-orange">
          <div class="kpi-icon">üí∞</div>
          <div><h3 id="kTotal" class="kpi-value">$0</h3><p class="kpi-label">Facturaci√≥n</p></div>
        </article>
        <article class="kpi-card kpi-green">
          <div class="kpi-icon">üìã</div>
          <div><h3 id="kOT" class="kpi-value">0</h3><p class="kpi-label">√ìrdenes</p></div>
        </article>
        <article class="kpi-card kpi-amber">
          <div class="kpi-icon">üõ†Ô∏è</div>
          <div><h3 id="kTopSrv" class="kpi-value">‚Äî</h3><p class="kpi-label">Servicio Top</p></div>
        </article>
        <article class="kpi-card kpi-blue">
          <div class="kpi-icon">üë•</div>
          <div><h3 id="kClientes" class="kpi-value">0</h3><p class="kpi-label">Clientes nuevos</p></div>
        </article>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="card-head"><h3>Ventas por d√≠a</h3></div>
          <div class="card-body"><div id="ventasDia" class="bars"></div></div>
        </div>

        <div class="card">
          <div class="card-head"><h3>Top servicios</h3></div>
          <div class="card-body">
            <div id="topServicios" class="table-wrap"><div class="skeleton"></div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Estilos locales breves para las barras -->
  <style>
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width: 900px){.grid2{grid-template-columns:1fr}}
    .bars{display:grid;grid-auto-rows:28px;gap:8px;padding:12px}
    .bar{display:flex;gap:10px;align-items:center}
    .bar .label{width:90px;font-size:12px;color:#64748b;white-space:nowrap}
    .bar .track{flex:1;background:#f1f5f9;border-radius:999px;overflow:hidden}
    .bar .fill{height:10px;background:#fb923c;border-radius:999px}
  </style>
  <script>
  /* ===== Helpers de sesi√≥n ===== */
  function _hardLogout(){ try{localStorage.removeItem('token');localStorage.removeItem('user')}finally{location.replace('/')} }
  window.logout = _hardLogout;
  document.addEventListener('click',(e)=>{const b=e.target.closest('#btnLogout');if(!b)return;e.preventDefault();_hardLogout();});

  /* ===== Detecci√≥n de API base ===== */
  const DEV_PORTS = ['4321','4322','4323'];
  const API_BASE = DEV_PORTS.includes(location.port) ? 'http://localhost:3001' : location.origin;
  const api = (p) => `${API_BASE}${p}`;

  /* ===== Utils ===== */
  const money = new Intl.NumberFormat('es-EC',{style:'currency',currency:'USD'});

  /* ===== Init + guard ===== */
  (async()=>{
    const t = localStorage.getItem('token');
    const u = localStorage.getItem('user');
    if(!t || !u) return _hardLogout();

    try{
      const r = await fetch(api('/api/auth/verify'), { headers:{ Authorization:`Bearer ${t}` } });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j?.success) return _hardLogout();
    }catch{ return _hardLogout(); }

    const user = JSON.parse(u);
    if(user.rol !== 'admin') return _hardLogout();
    const w = document.getElementById('userWelcome'); if (w) w.textContent = `Bienvenido, ${user.nombre}`;

    // Fechas por defecto (1¬∫ del mes ‚Üí hoy) si est√°n vac√≠as
    const dDesde = document.getElementById('fDesde');
    const dHasta = document.getElementById('fHasta');
    const today = new Date(), yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
    if (dDesde && !dDesde.value) dDesde.value = `${yyyy}-${mm}-01`;
    if (dHasta && !dHasta.value) dHasta.value = `${yyyy}-${mm}-${dd}`;

    apply();
  })();

  /* ===== Eventos ===== */
  document.getElementById('btnAplicar')?.addEventListener('click', apply);
  document.getElementById('btnExport')?.addEventListener('click', exportCSV);

  /* ===== Llamadas ===== */
  async function apply(){
    const t = localStorage.getItem('token');
    const desde = document.getElementById('fDesde').value;
    const hasta = document.getElementById('fHasta').value;

    const url = new URL(api('/api/reportes')); // ‚úÖ corregido
    if(desde) url.searchParams.set('desde', desde);
    if(hasta) url.searchParams.set('hasta', hasta);

    let data = { resumen:{}, ventas_dia:[], top_servicios:[] };
    try{
      const r = await fetch(url, { headers:{ Authorization:`Bearer ${t}` } });
      if (r.status === 401) return _hardLogout();
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      data = await r.json();
    }catch(err){
      console.error('Reporte: error consultando API', err);
    }

    const { resumen={}, ventas_dia=[], top_servicios=[] } = data;

    document.getElementById('kTotal').textContent    = money.format(resumen.total||0);
    document.getElementById('kOT').textContent       = resumen.ordenes||0;
    document.getElementById('kClientes').textContent = resumen.clientes_nuevos||0;
    document.getElementById('kTopSrv').textContent   = top_servicios?.[0]?.nombre || '‚Äî';

    renderVentasDia(ventas_dia);
    renderTopServicios(top_servicios);
  }

  async function exportCSV(){
    const t = localStorage.getItem('token');
    const desde = document.getElementById('fDesde').value;
    const hasta = document.getElementById('fHasta').value;

    const url = new URL(api('/api/reportes/export')); // ‚úÖ corregido
    if(desde) url.searchParams.set('desde', desde);
    if(hasta) url.searchParams.set('hasta', hasta);

    try{
      const r = await fetch(url, { headers:{ Authorization:`Bearer ${t}` } });
      if (r.status === 401) return _hardLogout();
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'reportes.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }catch(err){
      console.error('Export CSV: error', err);
      alert('No se pudo exportar');
    }
  }

  /* ===== Render ===== */
  function renderVentasDia(rows){
    const cont = document.getElementById('ventasDia');
    if(!rows.length){ cont.innerHTML = '<div class="muted">Sin datos</div>'; return; }
    const max = Math.max(...rows.map(r => +r.total||0), 1);
    cont.innerHTML = rows.map(r => {
      const w = Math.round(((+r.total||0)/max)*100);
      const f = isNaN(Date.parse(r.fecha)) ? r.fecha : new Date(r.fecha).toLocaleDateString('es-EC');
      return `
        <div class="bar">
          <div class="label">${f}</div>
          <div class="track"><div class="fill" style="width:${w}%"></div></div>
          <div class="label">${money.format(+r.total||0)}</div>
        </div>`;
    }).join('');
  }

  function renderTopServicios(items){
    const wrap = document.getElementById('topServicios');
    if(!items.length){ wrap.innerHTML = '<div class="muted">Sin datos</div>'; return; }
    wrap.innerHTML = `
      <table>
        <thead><tr><th>Servicio</th><th>Veces</th><th>Ingresos</th></tr></thead>
        <tbody>
          ${items.map(s=>`<tr><td>${s.nombre}</td><td>${s.cantidad}</td><td>${money.format(+s.total||0)}</td></tr>`).join('')}
        </tbody>
      </table>`;
  }
</script>

  <!-- Estilos globales (coherentes con Facturaci√≥n) -->
  <style is:global>
    :root{
      --container: 1200px; --bg:#f8fafc; --card:#fff; --text:#1a1a1a; --muted:#6b7280;
      --border:#e6eaf1; --border-2:#edf1f6; --blue-700:#1e3a8a; --blue-500:#3b82f6;
      --orange:#ff4500; --green:#22c55e; --amber:#f59e0b; --blue:#3b82f6; --red:#ef4444;
    }
    .page{padding:24px 0 40px;background:var(--bg)}
    .container{max-width:var(--container);margin:0 auto;padding:0 20px}
    .muted{color:var(--muted)}
    .navbar{position:sticky;top:0;z-index:50;background:linear-gradient(135deg,var(--blue-700),var(--blue-500));color:#fff;box-shadow:0 6px 18px rgba(2,6,23,.12)}
    .navbar .container{display:flex;align-items:center;gap:16px;padding:10px 20px}
    .brand{display:inline-flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:700}
    .logo-circle{width:36px;height:36px;display:grid;place-items:center;border-radius:50%;background:rgba(255,255,255,.15);box-shadow:inset 0 0 0 1px rgba(255,255,255,.25)}
    .brand-text{color:#fff}
    .user-menu{margin-left:auto;display:inline-flex;gap:12px;align-items:center}
    .user-chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:#fff;font-weight:600;font-size:.875rem;backdrop-filter:saturate(140%) blur(2px)}
    #btnLogout{background:var(--red);color:#fff;border:0;border-radius:999px;padding:8px 14px;font-weight:700;box-shadow:0 6px 14px rgba(239,68,68,.22);cursor:pointer;transition:transform .12s,box-shadow .12s}
    #btnLogout:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(239,68,68,.28)}
    .header-row{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin:8px 0 14px;flex-wrap:wrap}
    .header-row h1{margin:0 0 6px;font-size:2rem;font-weight:800;color:#0f172a}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;font-size:.9rem}
    .btn-orange{background:var(--orange);color:#fff}
    .btn-outline{background:#fff;border:1px solid var(--border);color:var(--text)}
    .input{border:1px solid var(--border);border-radius:10px;padding:10px 12px;min-width:200px;font-size:.9rem;background:#fff;color:var(--text)}
    .input:focus{outline:none;border-color:var(--blue-500);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 22px rgba(2,6,23,.06);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;background:#fafbfc;border-bottom:1px solid var(--border-2)}
    .card-head h3{margin:0;font-size:1.125rem;font-weight:700;color:#0f172a}
    .card-body{padding:16px 18px 18px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin:14px 0 24px}
    .kpi-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:18px;display:flex;align-items:center;gap:14px;box-shadow:0 8px 22px rgba(2,6,23,.06);transition:transform .12s,box-shadow .12s}
    .kpi-card:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(2,6,23,.1)}
    .kpi-card.kpi-orange{border-left:4px solid var(--orange)}
    .kpi-card.kpi-green{border-left:4px solid var(--green)}
    .kpi-card.kpi-amber{border-left:4px solid var(--amber)}
    .kpi-card.kpi-blue{border-left:4px solid var(--blue)}
    .kpi-icon{font-size:28px;opacity:.85}
    .kpi-value{margin:0;font-size:1.5rem;font-weight:800;color:#0f172a}
    .kpi-label{margin:2px 0 0;color:var(--muted);font-weight:600;font-size:.85rem}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
    .table-wrap table{width:100%;border-collapse:collapse;background:#fff}
    .table-wrap thead th{background:#f8fafc;color:#0f172a;font-weight:700;font-size:.82rem;letter-spacing:.02em;text-transform:uppercase;text-align:left;padding:14px 12px;border-bottom:2px solid var(--border)}
    .table-wrap tbody td{padding:14px 12px;border-bottom:1px solid var(--border-2);font-size:.95rem;vertical-align:top}
    .table-wrap tbody tr:hover{background:#f6f9ff}
    .skeleton{height:140px;border-radius:10px;background:linear-gradient(90deg,#f2f4f8 25%,#e6eaf1 37%,#f2f4f8 63%);background-size:400% 100%;animation:sk 1.2s infinite}
    @keyframes sk{0%{background-position:100% 0}100%{background-position:0 0}}
    @media (max-width:640px){.actions .input{min-width:unset;width:100%}.actions{width:100%}}
  </style>
</Layout>
