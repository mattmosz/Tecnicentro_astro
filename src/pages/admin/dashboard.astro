---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Panel Administrativo - TecniCentro Ibarra Express">
  <!-- NAVBAR fija -->
  <header class="navbar" role="banner">
    <div class="container">
      <a href="/admin/dashboard" class="brand">
        <span class="logo-circle">üîß</span>
        <span class="brand-text">TecniCentro Ibarra Express</span>
      </a>

      <div class="user-menu">
        <span id="userWelcome" class="user-chip">Cargando‚Ä¶</span>
        <button
          type="button"
          id="btnLogout"
          class="btn btn-orange"
          onclick="window.logout?.()"
        >
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <!-- ENCABEZADO -->
      <div class="dashboard-header">
        <div>
          <h1>Panel de Administraci√≥n</h1>
          <p class="muted">Gesti√≥n integral del taller automotriz</p>
        </div>
      </div>

      <!-- KPIs -->
      <section aria-labelledby="kpis" class="section">
        <h2 id="kpis" class="sr-only">Indicadores clave</h2>
        <div class="stats-grid">
          <article class="kpi-card kpi-blue">
            <div class="kpi-icon">üë•</div>
            <div>
              <h3 id="totalClientes" class="kpi-value">0</h3>
              <p class="kpi-label">Clientes Registrados</p>
            </div>
          </article>

          <article class="kpi-card kpi-green">
            <div class="kpi-icon">üöó</div>
            <div>
              <h3 id="totalVehiculos" class="kpi-value">0</h3>
              <p class="kpi-label">Veh√≠culos en Sistema</p>
            </div>
          </article>

          <article class="kpi-card kpi-amber">
            <div class="kpi-icon">‚öôÔ∏è</div>
            <div>
              <h3 id="ordenesActivas" class="kpi-value">0</h3>
              <p class="kpi-label">√ìrdenes Activas</p>
            </div>
          </article>

          <article class="kpi-card kpi-orange">
            <div class="kpi-icon">üí∞</div>
            <div>
              <h3 id="facturasHoy" class="kpi-value">$0</h3>
              <p class="kpi-label">Facturaci√≥n Hoy</p>
            </div>
          </article>
        </div>
      </section>

      <!-- M√ìDULOS -->
      <section class="section">
        <h2 class="section-title">M√≥dulos del Sistema</h2>
        <nav class="nav-grid">
          <a href="/admin/clientes"   class="nav-card tone-blue"><div class="nav-icon">üë•</div><h3>Gesti√≥n de Clientes</h3><p>Administrar informaci√≥n de clientes y contactos</p></a>
          <a href="/admin/vehiculos"  class="nav-card tone-green"><div class="nav-icon">üöó</div><h3>Gesti√≥n de Veh√≠culos</h3><p>Registro y seguimiento de veh√≠culos</p></a>
          <a href="/admin/servicios"  class="nav-card tone-orange"><div class="nav-icon">üîß</div><h3>Servicios del Taller</h3><p>Cat√°logo de servicios y tarifas</p></a>
          <a href="/admin/ordenes"    class="nav-card tone-amber"><div class="nav-icon">üìã</div><h3>√ìrdenes de Trabajo</h3><p>Gesti√≥n de √≥rdenes y asignaciones</p></a>
          <a href="/admin/facturas"   class="nav-card tone-cyan"><div class="nav-icon">üßæ</div><h3>Facturaci√≥n</h3><p>Emisi√≥n y control de facturas</p></a>
          <a href="/admin/reportes"   class="nav-card tone-slate"><div class="nav-icon">üìä</div><h3>Reportes y An√°lisis</h3><p>Estad√≠sticas y reportes del negocio</p></a>
        </nav>
      </section>

      <!-- ACTIVIDAD -->
      <section class="section">
        <h2 class="section-title">Actividad Reciente</h2>
        <div class="activity">
          <div class="card">
            <div class="card-head">
              <h3>√öltimas √ìrdenes</h3>
            </div>
            <div id="recentOrders" class="card-body">
              <div class="skeleton"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3>√öltimas Facturas</h3>
            </div>
            <div id="recentFacturas" class="card-body">
              <div class="skeleton"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --blue:#1e40af;
      --blue-500:#3b82f6;
      --green-500:#22c55e;
      --amber-500:#f59e0b;
      --orange-500:#fb923c;
      --cyan-500:#06b6d4;
      --slate-500:#64748b;
      --ring: 0 1px 2px rgba(0,0,0,.04), 0 10px 20px rgba(2,6,23,.08);
      --radius:16px;
      --container:1200px;
    }

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .muted{color:var(--muted)}

    body{background:var(--bg)}
    .container{max-width:var(--container);margin-inline:auto;padding:0 20px}

    /* Navbar fija */
    .navbar{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #eef2f7;z-index:20}
    .navbar .container{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);font-weight:700}
    .logo-circle{display:grid;place-items:center;width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--orange-500),#ffb07a);box-shadow:var(--ring)}
    .brand-text{letter-spacing:.2px}

    .user-menu{display:flex;align-items:center;gap:12px}
    .user-chip{font-weight:600;color:var(--text)}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}
    .btn-outline:hover{box-shadow:var(--ring)}

    .page{padding:24px 0 48px}

    /* Header */
    .dashboard-header{display:flex;align-items:end;justify-content:space-between;margin:16px 0 24px}
    .dashboard-header h1{margin:0;font-size:28px;color:var(--text)}

    /* KPIs */
    .stats-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:18px}
    .kpi-card{display:flex;gap:14px;align-items:center;background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--ring);position:relative;overflow:hidden}
    .kpi-card::after{content:"";position:absolute;inset:auto 0 0 0;height:4px}
    .kpi-blue::after{background:linear-gradient(90deg,var(--blue),var(--blue-500))}
    .kpi-green::after{background:linear-gradient(90deg,#16a34a,var(--green-500))}
    .kpi-amber::after{background:linear-gradient(90deg,#d97706,var(--amber-500))}
    .kpi-orange::after{background:linear-gradient(90deg,#f97316,var(--orange-500))}
    .kpi-icon{font-size:28px}
    .kpi-value{margin:0;font-size:28px;line-height:1.1}
    .kpi-label{margin:2px 0 0;color:var(--muted);font-size:13px}

    /* M√≥dulos */
    .section{margin:28px 0}
    .section-title{text-align:center;margin:0 0 18px;color:var(--text);font-size:22px}
    .nav-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:18px}
    .nav-card{display:flex;flex-direction:column;gap:6px;min-height:150px;background:var(--card);border-radius:var(--radius);padding:18px;text-decoration:none;color:var(--text);box-shadow:var(--ring);transition:transform .2s ease}
    .nav-card:hover{transform:translateY(-4px)}
    .nav-icon{font-size:26px;opacity:.9;margin-bottom:6px}
    .nav-card h3{margin:0 0 4px;font-size:18px}
    .nav-card p{margin:0;color:var(--muted);font-size:13px}
    .tone-blue{border-top:3px solid var(--blue-500)}
    .tone-green{border-top:3px solid var(--green-500)}
    .tone-amber{border-top:3px solid var(--amber-500)}
    .tone-orange{border-top:3px solid var(--orange-500)}
    .tone-cyan{border-top:3px solid var(--cyan-500)}
    .tone-slate{border-top:3px solid var(--slate-500)}

    /* Actividad */
    .activity{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--ring);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
    .card-head h3{margin:0;font-size:16px}
    .card-body{padding:10px 16px 16px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left;padding:10px}
    tbody td{padding:12px 10px;border-top:1px solid #eef2f7}
    tr:hover td{background:#fafafa}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge-warning{background:#fff7ed;color:#c2410c}
    .badge-primary{background:#eff6ff;color:#1e40af}
    .badge-success{background:#ecfdf5;color:#065f46}

    /* Skeleton */
    .skeleton{height:64px;border-radius:12px;background:linear-gradient(90deg,#f2f4f8 25%,#e6eaf1 37%,#f2f4f8 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}

    @media (max-width: 1024px){
      .stats-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
      .nav-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
      .activity{grid-template-columns:1fr}
    }
    @media (max-width: 640px){
      .stats-grid,.nav-grid{grid-template-columns:1fr}
      .brand-text{display:none}
    }
  </style>

  <script>
    /* ---------- LOGOUT ROBUSTO (delegado + global) ---------- */
    function _hardLogout() {
      try {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      } finally {
        // Evita volver al dashboard con "Atr√°s"
        location.replace('/');
      }
    }
    // Disponible para cualquier onclick inline
    window.logout = _hardLogout;

    // Delegado: funciona aunque el bot√≥n se renderice despu√©s
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('#btnLogout');
      if (!btn) return;
      ev.preventDefault();
      _hardLogout();
    });

    /* ---------- Guard de autenticaci√≥n ---------- */
    (async () => {
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      if (!token || !userStr) return _hardLogout();

      // Verifica que el token siga vigente
      try {
        const r = await fetch('/api/auth/verify', { headers: { Authorization: `Bearer ${token}` } });
        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data?.success) return _hardLogout();
      } catch {
        return _hardLogout();
      }

      const user = JSON.parse(userStr);
      if (user.rol !== 'admin') return _hardLogout();

      document.getElementById('userWelcome').textContent = `Bienvenido, ${user.nombre}`;
      loadDashboardData();
    })();

    /* ---------- Dashboard data ---------- */
    const fmtNum = new Intl.NumberFormat('es-EC');
    const fmtMoney = new Intl.NumberFormat('es-EC',{ style:'currency', currency:'USD', maximumFractionDigits:0 });

    async function loadDashboardData(){
      try{
        console.log('Cargando datos del dashboard...');
        const token = localStorage.getItem('token');
        console.log('Token:', token ? 'presente' : 'ausente');
        const statsRes = await fetch('/api/admin/stats', { headers:{ Authorization:`Bearer ${token}` }});
        console.log('Response status:', statsRes.status);
        if (statsRes.ok){
          const s = await statsRes.json();
          console.log('Stats recibidas:', s);
          document.getElementById('totalClientes').textContent  = fmtNum.format(s.clientes||0);
          document.getElementById('totalVehiculos').textContent = fmtNum.format(s.vehiculos||0);
          document.getElementById('ordenesActivas').textContent = fmtNum.format(s.ordenesActivas||0);
          document.getElementById('facturasHoy').textContent    = fmtMoney.format(s.facturacionHoy||0);
        } else {
          console.error('Error en respuesta:', await statsRes.text());
        }
        await loadRecentActivity();
      }catch(err){ 
        console.error('Error cargando dashboard:', err); 
      }
    }

    async function loadRecentActivity(){
      try{
        const token = localStorage.getItem('token');
        const [ordenesRes, facturasRes] = await Promise.all([
          fetch('/api/ordenes?limit=5',  { headers:{ Authorization:`Bearer ${token}` }}),
          fetch('/api/facturas?limit=5', { headers:{ Authorization:`Bearer ${token}` }})
        ]);

        if (ordenesRes.ok){
          const list = await ordenesRes.json();
          renderOrdenes(list);
        }
        if (facturasRes.ok){
          const list = await facturasRes.json();
          renderFacturas(list);
        }
      }catch(err){ console.error(err); }
    }

    function renderOrdenes(ordenes=[]){
      const el = document.getElementById('recentOrders');
      if (!ordenes.length){ el.innerHTML = '<div class="muted">No hay √≥rdenes registradas</div>'; return; }
      el.innerHTML = `
        <div class="table-wrap">
          <table>
            <thead><tr><th>ID</th><th>Cliente</th><th>Estado</th><th>Fecha</th></tr></thead>
            <tbody>
              ${ordenes.map(o=>`
                <tr>
                  <td>#${o.id}</td>
                  <td>${o.cliente_nombre||'N/A'}</td>
                  <td><span class="badge ${badge(o.estado)}">${o.estado}</span></td>
                  <td>${new Date(o.fecha_ingreso).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
    }

    function renderFacturas(facturas=[]){
      const el = document.getElementById('recentFacturas');
      if (!facturas.length){ el.innerHTML = '<div class="muted">No hay facturas registradas</div>'; return; }
      el.innerHTML = `
        <div class="table-wrap">
          <table>
            <thead><tr><th>N√∫mero</th><th>Cliente</th><th>Total</th><th>Fecha</th></tr></thead>
            <tbody>
              ${facturas.map(f=>`
                <tr>
                  <td>#${f.numero}</td>
                  <td>${f.cliente_nombre||'N/A'}</td>
                  <td>${fmtMoney.format(f.total||0)}</td>
                  <td>${new Date(f.fecha).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
    }

    function badge(estado=''){
      switch(estado.toLowerCase()){
        case 'pendiente': return 'badge badge-warning';
        case 'en proceso': return 'badge badge-primary';
        case 'completado':
        case 'entregado': return 'badge badge-success';
        default: return 'badge badge-primary';
      }
    }
  </script>
</Layout>