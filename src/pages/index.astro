---
import Layout from '../layouts/Layout.astro';
---

<Layout title="TecniCentro Ibarra Express - Login">
  <main>
    <div class="login-container">
      <div class="login-card">
        <div class="card-border"></div>

        <div class="logo-section">
          <div class="logo-circle">
            <span class="logo-icon">üîß</span>
          </div>
          <h1>TecniCentro</h1>
          <h2>Ibarra Express</h2>
          <p class="subtitle">Sistema de Gesti√≥n Automotriz</p>
        </div>

        <form id="loginForm" class="login-form" novalidate>
          <div class="form-group">
            <label for="usuario">Usuario</label>
            <div class="input-wrap">
              <span class="input-icon" aria-hidden="true">üë§</span>
              <input type="text" id="usuario" name="usuario" class="form-control" autocomplete="username" required placeholder="Ingresa tu usuario">
            </div>
          </div>

          <div class="form-group">
            <label for="clave">Contrase√±a</label>
            <div class="input-wrap">
              <span class="input-icon" aria-hidden="true">üîí</span>
              <input type="password" id="clave" name="clave" class="form-control" autocomplete="current-password" required placeholder="Ingresa tu contrase√±a">
              <button type="button" class="toggle-pass" id="togglePass" aria-label="Mostrar contrase√±a">üëÅÔ∏è</button>
            </div>
            <small id="capsHint" class="caps-hint" style="display:none;">Bloq May√∫s activado</small>
          </div>

          <div class="form-row">
            <label class="check">
              <input type="checkbox" id="remember" />
              <span>Recordarme</span>
            </label>
            <a class="link-muted" href="#" tabindex="-1">¬øOlvidaste tu contrase√±a?</a>
          </div>

          <button type="submit" class="btn btn-login" id="btnLogin">
            <span class="btn-text">Iniciar Sesi√≥n</span>
            <span class="btn-loading" style="display:none;">Ingresando‚Ä¶</span>
          </button>
        </form>

        <div id="toast" class="toast" role="alert" aria-live="polite" aria-atomic="true"></div>

        <div class="login-footer">
          <p>Sistema exclusivo para personal autorizado</p>
          <small>&copy; 2025 TecniCentro Ibarra Express</small>
        </div>
      </div>
    </div>
  </main>

  <style>
    /* ===== Canvas ===== */
    main{
      min-height:100vh;
      background:linear-gradient(135deg,var(--primary-blue) 0%,var(--secondary-blue) 50%,var(--primary-orange) 100%);
      display:grid;place-items:center;
      padding:24px;position:relative;overflow:hidden;
    }
    main::before{
      content:"";
      position:absolute;inset:0;
      background:
        radial-gradient(circle at 20% 80%, rgba(255,69,0,.10) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,.06) 0%, transparent 50%);
      pointer-events:none;
    }

    /* ===== Card ===== */
    .login-container{ width:min(420px,100%); z-index:1; }
    .login-card{
      position:relative;
      background:rgba(255,255,255,.9);
      backdrop-filter: blur(18px);
      border-radius:22px;
      padding:40px 34px 30px;
      box-shadow: 0 18px 45px rgba(12,40,84,.28);
      overflow:hidden;
      isolation:isolate;
      animation:slideUp .5s ease;
    }
    /* Borde degradado sutil */
    .card-border{
      position:absolute; inset:-1px;
      border-radius:24px;
      background:linear-gradient(135deg, rgba(255,255,255,.8), rgba(255,255,255,0) 30%, rgba(255,255,255,0) 70%, rgba(255,255,255,.6));
      mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      padding:1px;
      pointer-events:none;
    }

    @keyframes slideUp{ from{opacity:0; transform:translateY(24px)} to{opacity:1; transform:none} }

    /* ===== Branding ===== */
    .logo-section{ text-align:center; margin-bottom:30px; }
    .logo-circle{
      width:88px;height:88px;border-radius:50%;
      margin:0 auto 18px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary-orange), #FF6B35);
      box-shadow:0 12px 30px rgba(255,69,0,.35);
      position:relative;
    }
    .logo-circle::after{
      content:""; position:absolute; inset:-8px;
      border-radius:50%;
      background: radial-gradient(closest-side, rgba(255,255,255,.35), transparent 70%);
      filter: blur(8px);
      pointer-events:none;
    }
    .logo-icon{ font-size:38px; filter:drop-shadow(2px 2px 4px rgba(0,0,0,.18)); }

    .login-card h1{
      color:var(--primary-blue); font-size:30px; font-weight:800; margin:0;
      letter-spacing:-.4px;
    }
    .login-card h2{
      color:var(--primary-orange); font-size:20px; font-weight:700; margin:6px 0 8px;
    }
    .subtitle{
      color:#6c7480; font-size:13px; letter-spacing:.12em; text-transform:uppercase; margin:0;
    }

    /* ===== Form ===== */
    .login-form{ margin-top:6px; }
    .form-group{ margin-bottom:18px; }
    .form-group label{ display:block; color:#2b3440; font-weight:700; font-size:13px; margin:0 0 8px; }

    .input-wrap{
      position:relative; display:flex; align-items:center;
      background:rgba(255,255,255,.9);
      border:2px solid #e7eaf0; border-radius:12px;
      transition: border-color .2s, box-shadow .2s, background .2s;
    }
    .input-wrap:focus-within{
      border-color:var(--primary-blue);
      box-shadow:0 0 0 4px rgba(30,77,139,.12);
      background:#fff;
    }
    .input-icon{ padding-left:14px; font-size:18px; opacity:.85; }
    .form-control{
      width:100%; border:0; background:transparent;
      padding:14px 16px; padding-left:10px; font-size:15px;
      outline:none; border-radius:12px;
    }
    .toggle-pass{
      position:absolute; right:10px; border:0; background:transparent;
      cursor:pointer; font-size:18px; opacity:.7; transition:opacity .2s;
    }
    .toggle-pass:hover{ opacity:1; }

    .form-row{
      display:flex; align-items:center; justify-content:space-between;
      margin:6px 0 18px;
    }
    .check{ display:inline-flex; align-items:center; gap:8px; user-select:none; color:#4d5562; font-size:13px; }
    .check input{ width:16px; height:16px; accent-color:var(--primary-blue); }
    .link-muted{ color:#6c7480; font-size:13px; text-decoration:none; }
    .link-muted:hover{ text-decoration:underline; }

    .caps-hint{
      color:#c2410c; font-weight:700; font-size:12px; margin-top:6px;
    }

    /* ===== Button ===== */
    .btn-login{
      width:100%; border:0; cursor:pointer;
      border-radius:12px; padding:14px 20px; font-weight:800; letter-spacing:.4px;
      color:#fff;
      background:linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
      position:relative; overflow:hidden; transition:transform .15s ease, box-shadow .15s ease, opacity .2s;
      box-shadow: 0 10px 26px rgba(30,77,139,.32);
      text-transform:uppercase;
    }
    .btn-login:disabled{ opacity:.7; cursor:not-allowed; }
    .btn-login:hover{ transform:translateY(-1px); box-shadow:0 14px 32px rgba(30,77,139,.4); }
    .btn-login::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      transform:translateX(-100%); transition:transform .6s ease;
    }
    .btn-login:hover::before{ transform:translateX(100%); }

    /* ===== Toast ===== */
    .toast{
      position:absolute; left:20px; right:20px; bottom:24px;
      background:#fff; color:#b42318;
      border:1px solid #ffd3cf; border-left:4px solid #ef4444;
      padding:12px 14px; border-radius:12px; box-shadow:0 12px 26px rgba(0,0,0,.08);
      display:none; font-weight:600; text-align:left;
    }
    .toast.show{ display:block; animation:fadeIn .2s ease; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }

    /* ===== Footer ===== */
    .login-footer{ margin-top:26px; padding-top:20px; border-top:1px solid #eef1f6; text-align:center; }
    .login-footer p{ color:#6c7480; margin:0 0 6px; font-weight:600; }
    .login-footer small{ color:#9aa3af; }

    /* ===== Responsive ===== */
    @media (max-width:480px){
      .login-card{ padding:30px 24px 24px; }
      .logo-circle{ width:76px; height:76px; }
    }

    @media (prefers-reduced-motion:reduce){
      .login-card, .btn-login::before{ animation:none; transition:none }
    }
  </style>

  <script>
    //@ts-nocheck
    document.addEventListener('DOMContentLoaded', () => {
      const loginForm   = document.getElementById('loginForm');
      const btnLogin    = document.getElementById('btnLogin');
      const toast       = document.getElementById('toast');
      const inputUser   = document.getElementById('usuario');
      const inputPass   = document.getElementById('clave');
      const togglePass  = document.getElementById('togglePass');
      const capsHint    = document.getElementById('capsHint');

      // ‚Äî‚Äî Toggle contrase√±a
      togglePass.addEventListener('click', () => {
        const isPwd = inputPass.getAttribute('type') === 'password';
        inputPass.setAttribute('type', isPwd ? 'text' : 'password');
        togglePass.textContent = isPwd ? 'üôà' : 'üëÅÔ∏è';
        inputPass.focus();
      });

      // ‚Äî‚Äî Aviso CapsLock
      const capsHandler = (e) => {
        const on = e.getModifierState && e.getModifierState('CapsLock');
        capsHint.style.display = on ? 'inline' : 'none';
      };
      inputPass.addEventListener('keyup', capsHandler);
      inputPass.addEventListener('keydown', capsHandler);

      // ‚Äî‚Äî Sesi√≥n ya activa
      const token = localStorage.getItem('token');
      const storedUser = localStorage.getItem('user');
      if (token && storedUser) {
        fetch('http://localhost:3001/api/auth/verify', { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json()).then(d => d?.success ? redirectToDashboard(JSON.parse(storedUser)) : clearSession())
          .catch(() => clearSession());
      }

      // ‚Äî‚Äî Submit
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!inputUser.value.trim() || !inputPass.value) {
          return showToast('Por favor complete usuario y contrase√±a.');
        }

        btnLogin.disabled = true;
        loginForm.classList.add('loading');

        const body = { usuario: inputUser.value.trim(), clave: inputPass.value };

        try {
          const res = await fetch('http://localhost:3001/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data?.success) {
            showToast(data?.message || `Error ${res.status}`);
          } else {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            redirectToDashboard(data.user);
          }
        } catch (err) {
          showToast('Error de conexi√≥n con el servidor');
        } finally {
          btnLogin.disabled = false;
          loginForm.classList.remove('loading');
        }
      });

      function redirectToDashboard(user){
        if (user?.rol === 'admin')   return location.href = '/admin/dashboard';
        if (user?.rol === 'tecnico') return location.href = '/tecnico/dashboard';
      }
      function clearSession(){ localStorage.removeItem('token'); localStorage.removeItem('user'); }
      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3500);
      }
    });
  </script>
</Layout>
